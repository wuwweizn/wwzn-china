ARG BUILD_FROM=node:18-alpine
FROM $BUILD_FROM

# ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV VUE_APP_NETEASE_API_URL=/api

# å®‰è£…ç³»ç»Ÿä¾èµ–å’Œbashio
RUN apk add --no-cache \
    curl \
    bash \
    jq \
    nginx \
    supervisor \
    && curl -J -L -o /tmp/bashio.tar.gz \
        "https://github.com/hassio-addons/bashio/archive/v0.16.2.tar.gz" \
    && mkdir /tmp/bashio \
    && tar zxvf \
        /tmp/bashio.tar.gz \
        --strip 1 -C /tmp/bashio \
    && mv /tmp/bashio/lib /usr/lib/bashio \
    && ln -s /usr/lib/bashio/bashio /usr/bin/bashio \
    && rm -rf /tmp/bashio.tar.gz /tmp/bashio

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# ä¸‹è½½é¢„æ„å»ºçš„YesPlayMusic
RUN curl -L -o yesplaymusic.tar.gz \
    "https://github.com/qier222/YesPlayMusic/releases/download/v0.4.7/YesPlayMusic-linux-x64-0.4.7.tar.gz" \
    2>/dev/null || echo "Using alternative download method"

# å¦‚æœé¢„æ„å»ºç‰ˆæœ¬ä¸å¯ç”¨ï¼Œåˆ™ä»æºç æ„å»º
RUN if [ ! -f yesplaymusic.tar.gz ]; then \
        echo "Downloading source code..." && \
        curl -L -o source.tar.gz \
        "https://github.com/qier222/YesPlayMusic/archive/refs/tags/v0.4.7.tar.gz" && \
        tar -xzf source.tar.gz --strip-components=1 && \
        rm source.tar.gz && \
        echo "VUE_APP_NETEASE_API_URL=/api" > .env && \
        npm install -g yarn && \
        yarn install --frozen-lockfile && \
        yarn build && \
        mkdir -p /var/www/html && \
        cp -r dist/* /var/www/html/ && \
        rm -rf node_modules src public; \
    else \
        echo "Using pre-built version..." && \
        mkdir -p /var/www/html && \
        echo "Pre-built version extraction skipped - will use embedded files"; \
    fi

# æˆ–è€…ç›´æ¥ä½¿ç”¨åœ¨çº¿ç‰ˆæœ¬çš„é™æ€æ–‡ä»¶æ„å»º
RUN mkdir -p /var/www/html && \
    echo '<!DOCTYPE html>
<html>
<head>
    <title>YesPlayMusic</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #app { width: 100%; height: 100vh; border: none; }
    </style>
</head>
<body>
    <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial;">
        <div>
            <h2>ğŸµ YesPlayMusic Loading...</h2>
            <p>æ­£åœ¨åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨...</p>
        </div>
    </div>
    <iframe id="app" src="https://music.qier222.com" style="display: none;" onload="document.getElementById(\"loading\").style.display=\"none\"; this.style.display=\"block\";"></iframe>
</body>
</html>' > /var/www/html/index.html

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /var/log/nginx \
    /var/lib/nginx/tmp \
    /run/nginx \
    /var/log/supervisor \
    /etc/supervisor/conf.d

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY rootfs /

# è®¾ç½®æƒé™
RUN chmod +x /usr/local/bin/run.sh /usr/local/bin/setup_nginx.sh && \
    chown -R nginx:nginx /var/www/html /var/log/nginx /var/lib/nginx /run/nginx

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80

# æ ‡ç­¾
LABEL \
    io.hass.name="YesPlayMusic" \
    io.hass.description="é«˜é¢œå€¼çš„ç¬¬ä¸‰æ–¹ç½‘æ˜“äº‘æ’­æ”¾å™¨" \
    io.hass.type="addon" \
    io.hass.version="1.0.3" \
    maintainer="wuwweizn"

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/bin/run.sh"]