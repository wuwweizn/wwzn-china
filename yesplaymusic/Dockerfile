ARG BUILD_ARCH
FROM node:16-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    vips-dev \
    libc6-compat

# å…‹éš†YesPlayMusicæºç 
RUN git clone --depth 1 https://github.com/qier222/YesPlayMusic.git . || \
    (echo "ä¸»ä»“åº“å…‹éš†å¤±è´¥ï¼Œå°è¯•é•œåƒä»“åº“" && \
     git clone --depth 1 https://gitee.com/qier222/YesPlayMusic.git .)

# è®¾ç½®npmé•œåƒæº
RUN npm config set registry https://registry.npmmirror.com/

# åˆ›å»º.envé…ç½®æ–‡ä»¶
RUN cat > .env << 'EOF'
# API åœ°å€
VUE_APP_NETEASE_API_URL=/api

# åº”ç”¨é…ç½®
VUE_APP_TITLE=YesPlayMusic
VUE_APP_VERSION=1.0.0

# æ„å»ºé…ç½®
NODE_ENV=production
EOF

# å®‰è£…ä¾èµ– - ä½¿ç”¨å¤šç§ç­–ç•¥
RUN npm ci --only=production --legacy-peer-deps || \
    npm install --legacy-peer-deps --production=false || \
    (rm -rf node_modules package-lock.json && npm install --legacy-peer-deps)

# è®¾ç½®Node.jså†…å­˜é™åˆ¶
ENV NODE_OPTIONS="--max-old-space-size=2048"

# æ„å»ºé¡¹ç›®
RUN npm run build || \
    (echo "æ ‡å‡†æ„å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡å»º" && \
     npm run clean && npm run build) || \
    (echo "å°è¯•å¼ºåˆ¶æ„å»º" && \
     NODE_ENV=production npm run build:prod) || \
    (echo "æœ€åå°è¯•ï¼šç®€åŒ–æ„å»º" && \
     npm run build -- --mode production)

# éªŒè¯æ„å»ºç»“æœ
RUN ls -la dist/ && \
    test -f dist/index.html || (echo "æ„å»ºå¤±è´¥ï¼šç¼ºå°‘index.html" && exit 1)

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache supervisor jq bash curl

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder /app/dist /usr/share/nginx/html

# éªŒè¯å¤åˆ¶ç»“æœ
RUN ls -la /usr/share/nginx/html/ && \
    test -f /usr/share/nginx/html/index.html || \
    (echo "å¤åˆ¶å¤±è´¥ï¼Œåˆ›å»ºå¤‡ç”¨é¡µé¢" && \
     cat > /usr/share/nginx/html/index.html << 'BACKUP'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YesPlayMusic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }
        .container {
            background: white; border-radius: 20px; padding: 40px;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            max-width: 500px; width: 90%;
        }
        .logo { font-size: 4rem; margin-bottom: 20px; }
        h1 { color: #333; font-size: 2rem; font-weight: 300; margin-bottom: 15px; }
        .subtitle { color: #667eea; margin-bottom: 30px; }
        .status { 
            padding: 20px; background: #f8fafc; border-radius: 12px; margin: 20px 0;
            border-left: 4px solid #48bb78;
        }
        .btn {
            display: inline-block; padding: 12px 24px; margin: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; text-decoration: none; border-radius: 20px;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸµ</div>
        <h1>YesPlayMusic</h1>
        <p class="subtitle">é«˜é¢œå€¼çš„ç¬¬ä¸‰æ–¹ç½‘æ˜“äº‘æ’­æ”¾å™¨</p>
        
        <div class="status">
            <p><strong>ğŸ“¡ æœåŠ¡çŠ¶æ€ï¼š</strong>è¿è¡Œä¸­</p>
            <p><strong>ğŸ”— APIåœ°å€ï¼š</strong>/api</p>
            <p><strong>â„¹ï¸ è¯´æ˜ï¼š</strong>YesPlayMusicæœåŠ¡å·²å¯åŠ¨ï¼ŒAPIä»£ç†å·²é…ç½®</p>
        </div>
        
        <a href="/api/" target="_blank" class="btn">ğŸ”§ æ£€æŸ¥API</a>
        <a href="javascript:location.reload()" class="btn">ğŸ”„ åˆ·æ–°</a>
    </div>
    
    <script>
        // å®šæœŸæ£€æŸ¥APIçŠ¶æ€
        async function checkAPI() {
            try {
                const response = await fetch('/api/');
                console.log('APIçŠ¶æ€:', response.status);
            } catch (e) {
                console.log('APIæ£€æŸ¥å¤±è´¥:', e);
            }
        }
        
        setInterval(checkAPI, 30000);
        checkAPI();
    </script>
</body>
</html>
BACKUP
    )

# æ³¨å…¥APIé…ç½®åˆ°YesPlayMusic
RUN if [ -f "/usr/share/nginx/html/index.html" ] && grep -q "yesplaymusic" /usr/share/nginx/html/index.html; then \
        echo "æ£€æµ‹åˆ°YesPlayMusicæ„å»ºç»“æœï¼Œæ³¨å…¥APIé…ç½®"; \
        sed -i 's|<head>|<head>\n  <script>\n    window.VUE_APP_NETEASE_API_URL = "/api";\n    console.log("APIé…ç½®å·²æ³¨å…¥:", window.VUE_APP_NETEASE_API_URL);\n  </script>|g' /usr/share/nginx/html/index.html; \
    fi

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf
COPY run.sh /run.sh  
COPY supervisord.conf /etc/supervisord.conf

# è®¾ç½®æƒé™
RUN chmod +x /run.sh

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/nginx /var/log/supervisor

# æš´éœ²ç«¯å£
EXPOSE 80 443

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

CMD ["/run.sh"]