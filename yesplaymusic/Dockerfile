FROM alpine:latest

# å®‰è£…å¿…è¦åŒ…
RUN apk add --no-cache curl bash jq nginx supervisor

# åˆ›å»ºnginxç”¨æˆ·
RUN addgroup -g 101 -S nginx && \
    adduser -S -D -H -u 101 -h /var/cache/nginx -s /sbin/nologin -G nginx -g nginx nginx

# åˆ›å»ºç›®å½•
RUN mkdir -p /var/www/html /var/log/nginx /var/lib/nginx/tmp /run/nginx /var/log/supervisor /etc/supervisor/conf.d

# åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„YesPlayMusicç•Œé¢
RUN cat > /var/www/html/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>YesPlayMusic</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸµ</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInUp 1s ease-out;
        }
        .logo { 
            font-size: 8rem; 
            margin-bottom: 1rem;
            animation: bounce 2s ease-in-out infinite;
        }
        .title { 
            font-size: 4rem; 
            margin-bottom: 1rem; 
            font-weight: 300;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .subtitle { 
            font-size: 1.5rem; 
            opacity: 0.9; 
            margin-bottom: 2rem; 
            line-height: 1.6;
        }
        .main-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 3rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeIn 1.5s ease-out;
        }
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }
        .feature-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 1s ease-out;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .feature-icon { 
            font-size: 3rem; 
            margin-bottom: 1rem; 
            display: block; 
        }
        .feature-title { 
            font-size: 1.3rem; 
            font-weight: 600; 
            margin-bottom: 0.8rem; 
        }
        .feature-desc { 
            opacity: 0.9; 
            line-height: 1.5; 
        }
        .action-section {
            text-align: center;
            margin: 3rem 0;
        }
        .btn {
            background: rgba(102,126,234,0.9);
            border: 2px solid rgba(102,126,234,1);
            color: white;
            padding: 1.2rem 3rem;
            border-radius: 50px;
            text-decoration: none;
            display: inline-block;
            margin: 0.8rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102,126,234,0.4);
        }
        .btn.primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            animation: glow 2s ease-in-out infinite alternate;
        }
        .btn.secondary {
            background: rgba(76,175,80,0.9);
            border-color: rgba(76,175,80,1);
        }
        .btn.secondary:hover {
            box-shadow: 0 15px 35px rgba(76,175,80,0.4);
        }
        .info-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .warning {
            background: rgba(255,152,0,0.2);
            border: 2px solid rgba(255,152,0,0.4);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }
        .warning-icon { font-size: 3rem; margin-bottom: 1rem; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(102,126,234,0.5); }
            to { box-shadow: 0 0 30px rgba(102,126,234,0.8); }
        }
        
        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .logo { font-size: 5rem; }
            .container { padding: 1rem; }
            .main-card { padding: 2rem; }
            .features-grid { grid-template-columns: 1fr; }
            .btn { padding: 1rem 2rem; margin: 0.5rem; }
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-online { background-color: #4caf50; }
        .status-offline { background-color: #f44336; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸµ</div>
            <h1 class="title">YesPlayMusic</h1>
            <p class="subtitle">
                é«˜é¢œå€¼çš„ç¬¬ä¸‰æ–¹ç½‘æ˜“äº‘æ’­æ”¾å™¨<br>
                ç°åœ¨è¿è¡Œåœ¨æ‚¨çš„ Home Assistant ä¸­
            </p>
        </div>
        
        <div class="warning">
            <div class="warning-icon">âš ï¸</div>
            <h3>æœåŠ¡çŠ¶æ€è¯´æ˜</h3>
            <p>å®˜æ–¹åœ¨çº¿æ¼”ç¤ºç«™ç‚¹å·²æš‚åœæœåŠ¡ï¼Œä½†æ‚¨ä»å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼š</p>
            <div style="margin-top: 1rem;">
                <span class="status-indicator status-offline"></span>å®˜æ–¹åœ¨çº¿ç‰ˆæœ¬: æš‚åœæœåŠ¡<br>
                <span class="status-indicator status-online"></span>æ¡Œé¢å®¢æˆ·ç«¯: æ­£å¸¸å¯ç”¨<br>
                <span class="status-indicator status-online"></span>è‡ªå»ºéƒ¨ç½²: å¯ç”¨
            </div>
        </div>
        
        <div class="main-card">
            <h2 style="text-align: center; margin-bottom: 2rem; font-size: 2rem;">ğŸ¶ åŠŸèƒ½ç‰¹è‰²</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <span class="feature-icon">ğŸ”</span>
                    <h3 class="feature-title">ç½‘æ˜“äº‘è´¦å·ç™»å½•</h3>
                    <p class="feature-desc">æ”¯æŒæ‰«ç ã€æ‰‹æœºå·ã€é‚®ç®±å¤šç§ç™»å½•æ–¹å¼ï¼ŒåŒæ­¥ä¸ªäººéŸ³ä¹åº“</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸ“º</span>
                    <h3 class="feature-title">MV é«˜æ¸…æ’­æ”¾</h3>
                    <p class="feature-desc">æ”¯æŒé«˜æ¸…MVæ’­æ”¾ï¼Œæ²‰æµ¸å¼è§†å¬ä½“éªŒ</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸ“ƒ</span>
                    <h3 class="feature-title">å®æ—¶æ­Œè¯æ˜¾ç¤º</h3>
                    <p class="feature-desc">ç²¾å‡†çš„æ­Œè¯åŒæ­¥æ˜¾ç¤ºï¼Œè·Ÿå”±æ›´è½»æ¾</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸ“»</span>
                    <h3 class="feature-title">ç§äºº FM ç”µå°</h3>
                    <p class="feature-desc">åŸºäºå–œå¥½çš„ä¸ªæ€§åŒ–æ¨èï¼Œå‘ç°æ›´å¤šå¥½éŸ³ä¹</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">â˜ï¸</span>
                    <h3 class="feature-title">éŸ³ä¹äº‘ç›˜</h3>
                    <p class="feature-desc">åŒæ­¥äº‘ç«¯éŸ³ä¹åº“ï¼Œéšæ—¶éšåœ°äº«å—ä¸ªäººæ”¶è—</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸŒš</span>
                    <h3 class="feature-title">ä¸»é¢˜åˆ‡æ¢</h3>
                    <p class="feature-desc">æ·±è‰²/æµ…è‰²ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢ï¼Œé€‚åº”ä¸åŒä½¿ç”¨åœºæ™¯</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸ§</span>
                    <h3 class="feature-title">é«˜å“è´¨éŸ³ä¹</h3>
                    <p class="feature-desc">æ”¯æŒæ— æŸéŸ³è´¨æ’­æ”¾ï¼Œaudiophileçº§åˆ«ä½“éªŒ</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">ğŸš«</span>
                    <h3 class="feature-title">æ— ç¤¾äº¤å¹²æ‰°</h3>
                    <p class="feature-desc">ä¸“æ³¨éŸ³ä¹æœ¬èº«ï¼Œæ— ä»»ä½•ç¤¾äº¤åŠŸèƒ½æ‰“æ‰°</p>
                </div>
            </div>
        </div>
        
        <div class="action-section">
            <h2 style="margin-bottom: 2rem; font-size: 2.5rem;">ğŸš€ å¼€å§‹ä½¿ç”¨</h2>
            <div style="margin-bottom: 2rem;">
                <a href="https://github.com/qier222/YesPlayMusic/releases/latest" target="_blank" class="btn primary">
                    ğŸ“¦ ä¸‹è½½æ¡Œé¢ç‰ˆï¼ˆæ¨èï¼‰
                </a>
                <a href="#" onclick="tryOnlineVersions()" class="btn secondary">
                    ğŸŒ å°è¯•åœ¨çº¿ç‰ˆæœ¬
                </a>
            </div>
        </div>
        
        <div class="info-section">
            <h3 style="margin-bottom: 1rem; font-size: 1.8rem;">ğŸ“‹ ä½¿ç”¨æŒ‡å—</h3>
            <div style="text-align: left; line-height: 1.8;">
                <p><strong>ğŸ¯ æ¨èæ–¹æ¡ˆï¼š</strong></p>
                <ol style="margin: 1rem 0; padding-left: 2rem;">
                    <li>ç‚¹å‡»ä¸Šæ–¹"ä¸‹è½½æ¡Œé¢ç‰ˆ"æŒ‰é’®</li>
                    <li>é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„å®‰è£…åŒ…ä¸‹è½½</li>
                    <li>å®‰è£…åç™»å½•ç½‘æ˜“äº‘è´¦å·</li>
                    <li>äº«å—å®Œæ•´çš„éŸ³ä¹ä½“éªŒ</li>
                </ol>
                
                <p style="margin-top: 2rem;"><strong>ğŸ›  è‡ªå»ºéƒ¨ç½²ï¼š</strong></p>
                <p>å¦‚éœ€å®Œå…¨æ§åˆ¶éƒ¨ç½²ï¼Œå¯å‚è€ƒä»¥ä¸‹æ­¥éª¤ï¼š</p>
                <ol style="margin: 1rem 0; padding-left: 2rem;">
                    <li>éƒ¨ç½² <a href="https://github.com/Binaryify/NeteaseCloudMusicApi" target="_blank" style="color: #4fc3f7;">NeteaseCloudMusicApi</a></li>
                    <li>å…‹éš†YesPlayMusicæºç å¹¶æ„å»º</li>
                    <li>é…ç½®APIåœ°å€å¹¶éƒ¨ç½²å‰ç«¯</li>
                </ol>
                
                <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 10px; margin: 1.5rem 0;">
                    <p><strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong></p>
                    <p>â€¢ æ¡Œé¢ç‰ˆåŠŸèƒ½æœ€å®Œæ•´ï¼Œæ”¯æŒç³»ç»Ÿé€šçŸ¥ã€å…¨å±€å¿«æ·é”®ç­‰</p>
                    <p>â€¢ ç™»å½•è´¦å·åå¯äº«å—ä¸ªæ€§åŒ–æ¨èå’Œäº‘åŒæ­¥</p>
                    <p>â€¢ æµ·å¤–ç”¨æˆ·ç™»å½•åå¯æ­£å¸¸æ’­æ”¾å¤§éƒ¨åˆ†æ­Œæ›²</p>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 3rem 0; opacity: 0.8;">
            <p>ğŸ”— æ›´å¤šä¿¡æ¯è¯·è®¿é—® <a href="https://github.com/qier222/YesPlayMusic" target="_blank" style="color: #4fc3f7;">GitHub é¡¹ç›®é¡µé¢</a></p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">ç”± <a href="https://github.com/qier222" target="_blank" style="color: #4fc3f7;">@qier222</a> å¼€å‘ç»´æŠ¤</p>
        </div>
    </div>
    
    <script>
        // å°è¯•æ£€æµ‹åœ¨çº¿ç‰ˆæœ¬
        function tryOnlineVersions() {
            const testUrls = [
                'https://music.qier222.com',
                'https://yesplaymusic.vercel.app',
                'https://yesplaymusic.netlify.app'
            ];
            
            let foundWorking = false;
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 2rem;
                border-radius: 15px;
                z-index: 1000;
                text-align: center;
                backdrop-filter: blur(10px);
            `;
            statusDiv.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ”</div>
                <p>æ­£åœ¨æœç´¢å¯ç”¨çš„åœ¨çº¿ç‰ˆæœ¬...</p>
                <div style="margin-top: 1rem;">
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #f44336; border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
                </div>
            `;
            document.body.appendChild(statusDiv);
            
            testUrls.forEach((url, index) => {
                setTimeout(() => {
                    fetch(url, { mode: 'no-cors', method: 'HEAD' })
                        .then(() => {
                            if (!foundWorking) {
                                foundWorking = true;
                                statusDiv.innerHTML = `
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">âœ…</div>
                                    <p>æ‰¾åˆ°å¯ç”¨ç‰ˆæœ¬ï¼</p>
                                    <p style="margin: 1rem 0;">å³å°†è·³è½¬åˆ°ï¼š${url}</p>
                                `;
                                setTimeout(() => {
                                    window.open(url, '_blank');
                                    statusDiv.remove();
                                }, 2000);
                            }
                        })
                        .catch(() => {
                            if (index === testUrls.length - 1 && !foundWorking) {
                                statusDiv.innerHTML = `
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">âŒ</div>
                                    <p>æœªæ‰¾åˆ°å¯ç”¨çš„åœ¨çº¿ç‰ˆæœ¬</p>
                                    <p style="margin: 1rem 0; opacity: 0.8;">å»ºè®®ä¸‹è½½æ¡Œé¢ç‰ˆä½¿ç”¨</p>
                                    <div style="margin-top: 1rem;">
                                        <button onclick="this.parentElement.parentElement.remove()" style="background: #2196f3; border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">ç¡®å®š</button>
                                    </div>
                                `;
                            }
                        });
                }, index * 1000);
            });
        }
        
        // é¡µé¢åŠ è½½åŠ¨ç”»
        window.addEventListener('load', function() {
            const cards = document.querySelectorAll('.feature-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
            });
        });
        
        // èƒŒæ™¯åŠ¨æ€æ•ˆæœ
        document.addEventListener('mousemove', function(e) {
            const x = (e.clientX / window.innerWidth) * 100;
            const y = (e.clientY / window.innerHeight) * 100;
            document.body.style.background = `
                radial-gradient(circle at ${x}% ${y}%, rgba(102,126,234,0.3) 0%, transparent 50%),
                linear-gradient(135deg, #667eea 0%, #764ba2 100%)
            `;
        });
        
        // æ£€æµ‹APIçŠ¶æ€
        fetch('/api/ping')
            .then(response => {
                if (response.ok) {
                    console.log('APIè¿æ¥æ­£å¸¸');
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ APIæ­£å¸¸çš„æç¤º
                }
            })
            .catch(() => {
                console.log('APIè¿æ¥å¤±è´¥ï¼Œä½†ä¸å½±å“åŸºæœ¬åŠŸèƒ½');
            });
    </script>
</body>
</html>
EOF

# åˆ›å»ºnginxå’Œsupervisoré…ç½®
RUN cat > /etc/nginx/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log warn;

events { worker_connections 1024; }

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    gzip on;
    
    server {
        listen 80;
        root /var/www/html;
        index index.html;
        
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        location /api/ {
            proxy_pass https://music-api.hankqin.com/;
            proxy_set_header Host music-api.hankqin.com;
            proxy_ssl_verify off;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }
    }
}
EOF

RUN cat > /etc/supervisor/conf.d/supervisord.conf << 'EOF'
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true

[unix_http_server]
file=/var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
EOF

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /usr/local/bin/run.sh << 'EOF'
#!/bin/bash
set -e
echo "Starting YesPlayMusic..."
mkdir -p /var/log/supervisor /var/log/nginx /run/nginx
chown -R nginx:nginx /var/www/html /var/log/nginx /run/nginx /var/lib/nginx
nginx -t && exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
EOF

# è®¾ç½®æƒé™
RUN chown -R nginx:nginx /var/www/html /var/log/nginx /var/lib/nginx /run/nginx && \
    chmod +x /usr/local/bin/run.sh

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

EXPOSE 80

LABEL \
    io.hass.name="YesPlayMusic" \
    io.hass.description="é«˜é¢œå€¼çš„ç¬¬ä¸‰æ–¹ç½‘æ˜“äº‘æ’­æ”¾å™¨" \
    io.hass.type="addon" \
    io.hass.version="1.0.8"

CMD ["/usr/local/bin/run.sh"]