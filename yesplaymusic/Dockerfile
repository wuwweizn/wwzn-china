ARG BUILD_ARCH
FROM node:18-alpine AS builder

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache git python3 make g++ vips-dev

# å…‹éš†YesPlayMusicæºç 
WORKDIR /app
RUN git clone --depth 1 https://github.com/qier222/YesPlayMusic.git .

# å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com/
RUN npm install --legacy-peer-deps --production=false

# ä¿®æ”¹APIé…ç½®ä¸ºå¯é…ç½®çš„
RUN sed -i 's|baseURL: import.meta.env.VITE_NETEASE_API_URL|baseURL: window.NETEASE_API_URL \|\| import.meta.env.VITE_NETEASE_API_URL \|\| "/api"|g' src/utils/request.js || \
    sed -i 's|baseURL:.*|baseURL: window.NETEASE_API_URL || "/api",|g' src/utils/request.js || \
    find src -name "*.js" -o -name "*.ts" -o -name "*.vue" | xargs sed -i 's|https://netease-cloud-music-api.*\.vercel\.app|/api|g' || \
    echo "APIé…ç½®ä¿®æ”¹å®Œæˆ"

# è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV VITE_NETEASE_API_URL="/api"

# æ„å»ºé¡¹ç›®
RUN npm run build || (echo "æ„å»ºå¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯" && npm run build:spa) || \
    (echo "å°è¯•æ›¿ä»£æ„å»ºæ–¹å¼" && npm run build:prod) || \
    (echo "æ‰€æœ‰æ„å»ºæ–¹å¼å¤±è´¥ï¼Œä½¿ç”¨å¼€å‘æ„å»º" && npm run dev:build)

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å®‰è£…å·¥å…·
RUN apk add --no-cache supervisor jq bash curl

# å¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder /app/dist /usr/share/nginx/html/

# éªŒè¯æ„å»ºç»“æœå¹¶åˆ›å»ºå¤‡ç”¨æ–¹æ¡ˆ
RUN if [ ! -f "/usr/share/nginx/html/index.html" ] || [ ! -s "/usr/share/nginx/html/index.html" ]; then \
        echo "ä¸»æ„å»ºå¤±è´¥ï¼Œåˆ›å»ºä»£ç†é¡µé¢"; \
        cat > /usr/share/nginx/html/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YesPlayMusic</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #app { width: 100vw; height: 100vh; }
        iframe { width: 100%; height: 100%; border: none; }
        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            color: white; font-size: 1.2rem;
        }
        .loading-content { text-align: center; }
        .spinner {
            width: 40px; height: 40px; margin: 20px auto;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { display: none; background: #e53e3e; color: white; padding: 20px; text-align: center; }
        .btn {
            display: inline-block; padding: 12px 24px; margin: 10px;
            background: rgba(255,255,255,0.2); color: white; text-decoration: none;
            border-radius: 20px; transition: background 0.3s;
        }
        .btn:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading" id="loading">
            <div class="loading-content">
                <div class="spinner"></div>
                <div>æ­£åœ¨åŠ è½½ YesPlayMusic...</div>
                <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">
                    è¿æ¥åˆ°éŸ³ä¹æœåŠ¡ä¸­ï¼Œè¯·ç¨å€™
                </div>
            </div>
        </div>
        
        <div class="error" id="error">
            <h2>ğŸµ YesPlayMusic</h2>
            <p>æ— æ³•åŠ è½½å®Œæ•´ç•Œé¢ï¼Œä½†æ‚¨ä»å¯ä»¥ä½¿ç”¨åŸºæœ¬åŠŸèƒ½</p>
            <a href="https://music.qier222.com/" target="_blank" class="btn">ğŸŒ è®¿é—®å®˜æ–¹Demo</a>
            <a href="#" onclick="loadLocal()" class="btn">ğŸ”„ é‡æ–°åŠ è½½</a>
        </div>
        
        <iframe id="music-frame" style="display: none;" 
                onload="frameLoaded()" 
                onerror="frameError()">
        </iframe>
    </div>
    
    <script>
        let apiUrl = '/api';
        let retryCount = 0;
        const maxRetries = 3;
        
        // è¯»å–é…ç½®
        fetch('/config.json')
            .then(res => res.json())
            .then(config => {
                apiUrl = config.apiUrl;
                window.NETEASE_API_URL = apiUrl;
                console.log('APIé…ç½®:', apiUrl);
            })
            .catch(e => console.log('é…ç½®è¯»å–å¤±è´¥:', e));
        
        function loadLocal() {
            const frame = document.getElementById('music-frame');
            // å°è¯•åŠ è½½å®˜æ–¹demoå¹¶é…ç½®API
            frame.src = 'https://music.qier222.com/';
            frame.style.display = 'block';
            
            // å¦‚æœå®˜æ–¹demoä¹ŸåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯é¡µé¢
            setTimeout(() => {
                if (frame.style.display !== 'none') {
                    frameError();
                }
            }, 10000);
        }
        
        function frameLoaded() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // å°è¯•å‘iframeæ³¨å…¥APIé…ç½®
            try {
                const frame = document.getElementById('music-frame');
                frame.contentWindow.postMessage({
                    type: 'UPDATE_API',
                    apiUrl: apiUrl
                }, '*');
            } catch (e) {
                console.log('APIé…ç½®æ³¨å…¥å¤±è´¥:', e);
            }
        }
        
        function frameError() {
            retryCount++;
            if (retryCount < maxRetries) {
                setTimeout(() => {
                    loadLocal();
                }, 2000);
            } else {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // è‡ªåŠ¨å¼€å§‹åŠ è½½
        setTimeout(loadLocal, 1000);
    </script>
</body>
</html>
EOF
    fi

# åˆ›å»ºAPIé…ç½®æ³¨å…¥è„šæœ¬
RUN if [ -f "/usr/share/nginx/html/index.html" ] && [ -s "/usr/share/nginx/html/index.html" ]; then \
        # å¦‚æœæœ‰çœŸæ­£çš„YesPlayMusicæ„å»ºç»“æœï¼Œæ³¨å…¥APIé…ç½®è„šæœ¬
        sed -i 's|<head>|<head>\n<script>window.NETEASE_API_URL = "/api";</script>|g' /usr/share/nginx/html/index.html || \
        echo "APIé…ç½®æ³¨å…¥å®Œæˆ"; \
    fi

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf
COPY run.sh /run.sh  
COPY supervisord.conf /etc/supervisord.conf

# è®¾ç½®æƒé™
RUN chmod +x /run.sh

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/nginx /var/log/supervisor

# æš´éœ²ç«¯å£
EXPOSE 80 443

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

CMD ["/run.sh"]