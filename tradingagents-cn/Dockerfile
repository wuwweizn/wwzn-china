# TradingAgents-CN å¯åŠ¨é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜åˆ†æ

æ ¹æ®æ‚¨çš„é…ç½®ï¼Œå¯åŠ¨å¤±è´¥ä¸”æ— æ—¥å¿—è¾“å‡ºé€šå¸¸æ˜¯ç”±ä»¥ä¸‹åŸå› é€ æˆï¼š

### 1. ä¸»è¦é—®é¢˜å®šä½

#### A. bashio ä¾èµ–é—®é¢˜
å½“å‰é…ç½®ä½¿ç”¨äº† `bashio` å‘½ä»¤ï¼Œä½†åŸºç¡€é•œåƒå¯èƒ½ä¸åŒ…å«æ­¤å·¥å…·ï¼š

```bash
#!/usr/bin/with-contenv bashio
bashio::net.wait_for 8501
bashio::log.info "Starting TradingAgents-CN..."
```

#### B. è™šæ‹Ÿç¯å¢ƒé—®é¢˜
è™šæ‹Ÿç¯å¢ƒå¯èƒ½æœªæ­£ç¡®åˆ›å»ºæˆ–æ¿€æ´»å¤±è´¥ã€‚

#### C. æƒé™é—®é¢˜
è„šæœ¬æƒé™æˆ–æ–‡ä»¶æ‰€æœ‰æƒå¯èƒ½ä¸æ­£ç¡®ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ç°æœ‰é…ç½®

#### 1.1 ä¿®æ”¹ Dockerfile

```dockerfile
ARG BUILD_FROM
FROM $BUILD_FROM

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV LANG C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…å« bashioï¼‰
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    build-essential \
    libffi-dev \
    libssl-dev \
    jq \
    bash \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… bashio (Home Assistant CLIå·¥å…·)
RUN curl -J -L -o /usr/bin/bashio \
    "https://github.com/hassio-addons/bashio/releases/latest/download/bashio" \
    && chmod a+x /usr/bin/bashio

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /opt/tradingagents

# å…‹éš†é¡¹ç›®å¹¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜
RUN git config --global http.sslVerify false && \
    git clone https://github.com/hsliuping/TradingAgents-CN.git . || \
    (echo "Git clone failed, creating minimal structure" && \
     mkdir -p web && \
     echo "import streamlit as st; st.write('TradingAgents-CN Loading...')" > web/app.py)

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip setuptools wheel

# å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç¡®ä¿å³ä½¿requirements.txtä¸å­˜åœ¨ä¹Ÿèƒ½è¿è¡Œï¼‰
RUN /opt/venv/bin/pip install streamlit pandas numpy || true && \
    if [ -f requirements.txt ]; then /opt/venv/bin/pip install -r requirements.txt || true; fi && \
    /opt/venv/bin/pip install pytdx || true && \
    if [ -f requirements_db.txt ]; then /opt/venv/bin/pip install -r requirements_db.txt || true; fi

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY rootfs /

# è®¾ç½®æƒé™
RUN chmod +x /etc/services.d/tradingagents/run && \
    chmod +x /etc/services.d/tradingagents/finish && \
    chmod +x /etc/cont-init.d/01-setup.sh && \
    chmod +x /usr/bin/start-tradingagents.sh

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /data/tradingagents /config/tradingagents /share/tradingagents && \
    chown -R root:root /opt/tradingagents

# åˆ›å»ºæµ‹è¯•è„šæœ¬
RUN echo '#!/bin/bash\necho "Testing Python environment..."\n/opt/venv/bin/python --version\n/opt/venv/bin/pip list\necho "Environment test completed"' > /usr/bin/test-env.sh && \
    chmod +x /usr/bin/test-env.sh

EXPOSE 8501

# æ”¹è¿›å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=5 \
    CMD curl -f http://localhost:8501/_stcore/health || curl -f http://localhost:8501/ || exit 1

LABEL \
    io.hass.name="TradingAgents-CN" \
    io.hass.description="åŸºäºå¤šæ™ºèƒ½ä½“LLMçš„ä¸­æ–‡é‡‘èäº¤æ˜“æ¡†æ¶" \
    io.hass.arch="${TARGETARCH}" \
    io.hass.type="addon" \
    io.hass.version="1.0.0" \
    maintainer="wuwweizn"
```

#### 1.2 ä¿®æ”¹åˆå§‹åŒ–è„šæœ¬ (01-setup.sh)

```bash
#!/bin/bash
set -e

echo "=== TradingAgents-CN Setup Starting ==="

# é…ç½®æ–‡ä»¶è·¯å¾„
OPTIONS_FILE="/data/options.json"
ENV_FILE="/opt/tradingagents/.env"

# åˆ›å»ºé»˜è®¤é…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [[ ! -f "$OPTIONS_FILE" ]]; then
    echo "Creating default configuration..."
    mkdir -p /data
    cat > "$OPTIONS_FILE" <<EOF
{
  "dashscope_api_key": "",
  "finnhub_api_key": "",
  "google_api_key": "",
  "openai_api_key": "",
  "anthropic_api_key": "",
  "mongodb_enabled": false,
  "redis_enabled": false,
  "mongodb_host": "localhost",
  "mongodb_port": 27017,
  "redis_host": "localhost",
  "redis_port": 6379,
  "log_level": "info"
}
EOF
fi

echo "Parsing configuration options..."

# ä½¿ç”¨æ›´å®‰å…¨çš„é…ç½®è§£æ
DASHSCOPE_API_KEY=""
FINNHUB_API_KEY=""
GOOGLE_API_KEY=""
OPENAI_API_KEY=""
ANTHROPIC_API_KEY=""
MONGODB_ENABLED="false"
REDIS_ENABLED="false"
MONGODB_HOST="localhost"
MONGODB_PORT="27017"
REDIS_HOST="localhost"
REDIS_PORT="6379"
LOG_LEVEL="info"

# å¦‚æœjqå¯ç”¨ï¼Œä½¿ç”¨jqè§£æ
if command -v jq >/dev/null 2>&1; then
    DASHSCOPE_API_KEY=$(jq -r '.dashscope_api_key // ""' "$OPTIONS_FILE")
    FINNHUB_API_KEY=$(jq -r '.finnhub_api_key // ""' "$OPTIONS_FILE")
    GOOGLE_API_KEY=$(jq -r '.google_api_key // ""' "$OPTIONS_FILE")
    OPENAI_API_KEY=$(jq -r '.openai_api_key // ""' "$OPTIONS_FILE")
    ANTHROPIC_API_KEY=$(jq -r '.anthropic_api_key // ""' "$OPTIONS_FILE")
    MONGODB_ENABLED=$(jq -r '.mongodb_enabled // false' "$OPTIONS_FILE")
    REDIS_ENABLED=$(jq -r '.redis_enabled // false' "$OPTIONS_FILE")
    LOG_LEVEL=$(jq -r '.log_level // "info"' "$OPTIONS_FILE")
fi

echo "Creating environment configuration..."

# åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
cat > "$ENV_FILE" <<EOF
# API Keys
DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
FINNHUB_API_KEY=${FINNHUB_API_KEY}
GOOGLE_API_KEY=${GOOGLE_API_KEY}
OPENAI_API_KEY=${OPENAI_API_KEY}
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

# Database Configuration
MONGODB_ENABLED=${MONGODB_ENABLED}
REDIS_ENABLED=${REDIS_ENABLED}
MONGODB_HOST=${MONGODB_HOST}
MONGODB_PORT=${MONGODB_PORT}
REDIS_HOST=${REDIS_HOST}
REDIS_PORT=${REDIS_PORT}

# Paths
TRADING_AGENTS_DATA_DIR=/data/tradingagents

# Logging
LOG_LEVEL=${LOG_LEVEL}

# Streamlit Configuration
STREAMLIT_SERVER_ADDRESS=0.0.0.0
STREAMLIT_SERVER_PORT=8501
STREAMLIT_SERVER_HEADLESS=true
EOF

# ç¡®ä¿ç›®å½•å’Œæƒé™
mkdir -p /data/tradingagents /config/tradingagents /share/tradingagents
chown -R root:root /opt/tradingagents
chmod 644 "$ENV_FILE"

# æµ‹è¯•Pythonç¯å¢ƒ
echo "Testing Python environment..."
if /opt/venv/bin/python --version; then
    echo "âœ“ Python environment OK"
else
    echo "âœ— Python environment failed"
    exit 1
fi

# æµ‹è¯•Streamlit
echo "Testing Streamlit installation..."
if /opt/venv/bin/python -c "import streamlit; print(f'Streamlit version: {streamlit.__version__}')"; then
    echo "âœ“ Streamlit OK"
else
    echo "âœ— Streamlit failed"
    # å°è¯•å®‰è£…Streamlit
    /opt/venv/bin/pip install streamlit || echo "Failed to install Streamlit"
fi

echo "=== TradingAgents-CN Setup Completed ==="
```

#### 1.3 ä¿®æ”¹æœåŠ¡è¿è¡Œè„šæœ¬

```bash
#!/bin/bash
set -e

echo "=== Starting TradingAgents-CN Service ==="

# åŠ è½½ç¯å¢ƒå˜é‡
if [ -f /opt/tradingagents/.env ]; then
    set -a
    source /opt/tradingagents/.env
    set +a
    echo "âœ“ Environment loaded"
fi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [ -d /opt/venv ]; then
    source /opt/venv/bin/activate
    echo "âœ“ Virtual environment activated"
    echo "Python path: $(which python)"
    echo "Python version: $(python --version)"
else
    echo "âœ— Virtual environment not found"
    exit 1
fi

# åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
cd /opt/tradingagents || {
    echo "âœ— Failed to change to /opt/tradingagents"
    exit 1
}

echo "Current directory: $(pwd)"
echo "Directory contents:"
ls -la

# æ£€æŸ¥åº”ç”¨æ–‡ä»¶
if [ ! -f web/app.py ]; then
    echo "Creating minimal app.py..."
    mkdir -p web
    cat > web/app.py <<EOF
import streamlit as st
import sys
import os

st.set_page_config(
    page_title="TradingAgents-CN",
    page_icon="ğŸ“ˆ",
    layout="wide"
)

st.title("ğŸš€ TradingAgents-CN")
st.success("åº”ç”¨å·²æˆåŠŸå¯åŠ¨ï¼")

st.info("è¿™æ˜¯TradingAgents-CNçš„ä¸´æ—¶é¡µé¢ã€‚å®Œæ•´åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...")

st.subheader("ç¯å¢ƒä¿¡æ¯")
st.code(f"Pythonç‰ˆæœ¬: {sys.version}")
st.code(f"å·¥ä½œç›®å½•: {os.getcwd()}")

st.subheader("ç¯å¢ƒå˜é‡")
env_vars = {k: v for k, v in os.environ.items() if 'API_KEY' in k}
for k, v in env_vars.items():
    if v:
        st.code(f"{k}: {'*' * len(v)}")
    else:
        st.code(f"{k}: æœªè®¾ç½®")
EOF
fi

echo "âœ“ Application file ready"

# ç­‰å¾…ç½‘ç»œå°±ç»ª
echo "Waiting for network..."
sleep 10

# å¯åŠ¨åº”ç”¨
echo "ğŸš€ Starting Streamlit application..."

exec python -m streamlit run web/app.py \
    --server.address 0.0.0.0 \
    --server.port 8501 \
    --server.headless true \
    --server.enableCORS false \
    --server.enableXsrfProtection false \
    --server.fileWatcherType none \
    --server.runOnSave false \
    --global.developmentMode false
```

### æ–¹æ¡ˆ2ï¼šç®€åŒ–ç‰ˆé…ç½®ï¼ˆæ¨èï¼‰

å¦‚æœä¸Šè¿°ä¿®å¤ä»æœ‰é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨ç®€åŒ–çš„s6-overlayé…ç½®ï¼š

#### 2.1 ç®€åŒ–çš„æœåŠ¡è„šæœ¬ (run)

```bash
#!/usr/bin/execlineb -P
with-contenv
exec /usr/bin/start-tradingagents.sh
```

#### 2.2 ç®€åŒ–çš„å¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
set -e

echo "Starting TradingAgents-CN..."

# åŸºç¡€æ£€æŸ¥
cd /opt/tradingagents

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source /opt/venv/bin/activate

# ç®€å•çš„åº”ç”¨å¯åŠ¨
exec streamlit run web/app.py --server.address 0.0.0.0 --server.port 8501 --server.headless true
```

## è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
# åœ¨Home Assistantä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs addon_<addon_id> -f

# æˆ–è€…è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it addon_<addon_id> /bin/bash
```

### 2. æµ‹è¯•ç¯å¢ƒ

è¿›å…¥å®¹å™¨åæ‰§è¡Œï¼š

```bash
# æµ‹è¯•Python
/opt/venv/bin/python --version

# æµ‹è¯•Streamlit
/opt/venv/bin/python -c "import streamlit; print('OK')"

# æ‰‹åŠ¨å¯åŠ¨åº”ç”¨
cd /opt/tradingagents
/opt/venv/bin/python -m streamlit run web/app.py --server.port 8501
```

### 3. æ£€æŸ¥æ–‡ä»¶æƒé™

```bash
ls -la /etc/services.d/tradingagents/
ls -la /usr/bin/start-tradingagents.sh
```

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæœ€å°åŒ–çš„ç‰ˆæœ¬æ¥æµ‹è¯•ï¼š

1. å…ˆç¡®ä¿åŸºç¡€Dockeré•œåƒèƒ½æ­£å¸¸å¯åŠ¨
2. é€æ­¥æ·»åŠ åŠŸèƒ½
3. ä½¿ç”¨ç®€å•çš„Python HTTPæœåŠ¡å™¨ä½œä¸ºæµ‹è¯•

è¿™æ ·å¯ä»¥é€æ­¥å®šä½é—®é¢˜æ‰€åœ¨ã€‚