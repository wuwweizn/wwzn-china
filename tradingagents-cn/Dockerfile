ARG BUILD_FROM
FROM $BUILD_FROM

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV LANG C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆDebian/Ubuntuï¼‰
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    git \
    curl \
    build-essential \
    libffi-dev \
    libssl-dev \
    jq \
    bash \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /opt/tradingagents

# å…‹éš†é¡¹ç›®å¹¶å¤„ç†å¯èƒ½çš„ç½‘ç»œé—®é¢˜
RUN git config --global http.sslVerify false && \
    (git clone https://github.com/hsliuping/TradingAgents-CN.git . || \
     echo "Git clone failed, creating minimal structure") && \
    mkdir -p web

# åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒå¹¶å®‰è£…ä¾èµ–
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --upgrade pip setuptools wheel

# å®‰è£…åŸºç¡€ä¾èµ–
RUN /opt/venv/bin/pip install streamlit pandas numpy requests || true && \
    if [ -f requirements.txt ]; then /opt/venv/bin/pip install -r requirements.txt || true; fi && \
    /opt/venv/bin/pip install pytdx || true && \
    if [ -f requirements_db.txt ]; then /opt/venv/bin/pip install -r requirements_db.txt || true; fi

# åˆ›å»ºé»˜è®¤åº”ç”¨ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
RUN if [ ! -f web/app.py ]; then \
    cat > web/app.py <<EOF && \
import streamlit as st
import sys
import os
import platform

st.set_page_config(
    page_title="TradingAgents-CN",
    page_icon="ðŸ“ˆ",
    layout="wide"
)

st.title("ðŸš€ TradingAgents-CN")
st.success("åº”ç”¨å·²æˆåŠŸå¯åŠ¨ï¼")

st.info("è¿™æ˜¯TradingAgents-CNçš„å¯åŠ¨é¡µé¢ã€‚")

col1, col2 = st.columns(2)

with col1:
    st.subheader("ðŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯")
    st.code(f"æ“ä½œç³»ç»Ÿ: {platform.system()} {platform.release()}")
    st.code(f"Pythonç‰ˆæœ¬: {sys.version}")
    st.code(f"å·¥ä½œç›®å½•: {os.getcwd()}")

with col2:
    st.subheader("ðŸ”‘ çŽ¯å¢ƒå˜é‡")
    api_keys = {k: v for k, v in os.environ.items() if 'API_KEY' in k}
    if api_keys:
        for k, v in api_keys.items():
            if v:
                st.code(f"{k}: âœ… å·²é…ç½®")
            else:
                st.code(f"{k}: âŒ æœªé…ç½®")
    else:
        st.code("æœªæ‰¾åˆ°APIå¯†é’¥é…ç½®")

st.subheader("ðŸ“ é…ç½®è¯´æ˜Ž")
st.markdown("""
è¯·åœ¨Home AssistantåŠ è½½é¡¹é…ç½®ä¸­è®¾ç½®ä»¥ä¸‹APIå¯†é’¥ï¼š
- **dashscope_api_key**: é˜¿é‡Œç™¾ç‚¼APIå¯†é’¥ï¼ˆå¿…éœ€ï¼‰
- **finnhub_api_key**: FinnHubè‚¡ç¥¨æ•°æ®APIå¯†é’¥ï¼ˆå¿…éœ€ï¼‰
- **openai_api_key**: OpenAI APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
- **google_api_key**: Google AI APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
- **anthropic_api_key**: Anthropic APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
""")
EOF \
    fi

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY rootfs /

# è®¾ç½®æƒé™
RUN chmod +x /etc/services.d/tradingagents/run && \
    chmod +x /etc/services.d/tradingagents/finish && \
    chmod +x /etc/cont-init.d/01-setup.sh && \
    chmod +x /usr/bin/start-tradingagents.sh

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /data/tradingagents /config/tradingagents && \
    chown -R root:root /opt/tradingagents

EXPOSE 8501

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=5 \
    CMD curl -f http://localhost:8501/_stcore/health || curl -f http://localhost:8501/ || exit 1

LABEL \
    io.hass.name="TradingAgents-CN" \
    io.hass.description="åŸºäºŽå¤šæ™ºèƒ½ä½“LLMçš„ä¸­æ–‡é‡‘èžäº¤æ˜“æ¡†æž¶" \
    io.hass.arch="${TARGETARCH}" \
    io.hass.type="addon" \
    io.hass.version="1.0.0" \
    maintainer="wuwweizn"