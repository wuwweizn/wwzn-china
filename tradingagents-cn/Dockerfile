FROM python:3.11-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV LANG=C.UTF-8 \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# å®‰è£…ç³»ç»Ÿä¾èµ– + pandoc
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    jq \
    pandoc \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /opt/tradingagents

# å…‹éš†é¡¹ç›®
RUN git clone https://github.com/hsliuping/TradingAgents-CN.git . && \
    git checkout main

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir pytdx && \
    (pip install --no-cache-dir -r requirements_db.txt || echo "Database requirements optional")

# ç¦ç”¨pypandocçš„è‡ªåŠ¨ä¸‹è½½åŠŸèƒ½
ENV PYPANDOC_PANDOC=/usr/bin/pandoc

# åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆåŒ…å« TUSHARE_TOKEN æ”¯æŒï¼‰
RUN echo '#!/bin/bash\n\
echo "Starting TradingAgents-CN..."\n\
\n\
# è§£æé…ç½®\n\
OPTIONS_FILE="/data/options.json"\n\
if [[ -f "$OPTIONS_FILE" ]]; then\n\
    echo "Loading configuration from $OPTIONS_FILE"\n\
    DASHSCOPE_API_KEY=$(cat "$OPTIONS_FILE" | jq -r ".dashscope_api_key // \"\"")\n\
    TUSHARE_TOKEN=$(cat "$OPTIONS_FILE" | jq -r ".tushare_token // \"\"")\n\
    FINNHUB_API_KEY=$(cat "$OPTIONS_FILE" | jq -r ".finnhub_api_key // \"\"")\n\
    GOOGLE_API_KEY=$(cat "$OPTIONS_FILE" | jq -r ".google_api_key // \"\"")\n\
    OPENAI_API_KEY=$(cat "$OPTIONS_FILE" | jq -r ".openai_api_key // \"\"")\n\
    ANTHROPIC_API_KEY=$(cat "$OPTIONS_FILE" | jq -r ".anthropic_api_key // \"\"")\n\
    MONGODB_ENABLED=$(cat "$OPTIONS_FILE" | jq -r ".mongodb_enabled // false")\n\
    REDIS_ENABLED=$(cat "$OPTIONS_FILE" | jq -r ".redis_enabled // false")\n\
    MONGODB_HOST=$(cat "$OPTIONS_FILE" | jq -r ".mongodb_host // \"localhost\"")\n\
    MONGODB_PORT=$(cat "$OPTIONS_FILE" | jq -r ".mongodb_port // 27017")\n\
    REDIS_HOST=$(cat "$OPTIONS_FILE" | jq -r ".redis_host // \"localhost\"")\n\
    REDIS_PORT=$(cat "$OPTIONS_FILE" | jq -r ".redis_port // 6379")\n\
    LOG_LEVEL=$(cat "$OPTIONS_FILE" | jq -r ".log_level // \"info\"")\n\
else\n\
    echo "No configuration file found, using defaults"\n\
    DASHSCOPE_API_KEY=""\n\
    TUSHARE_TOKEN=""\n\
    FINNHUB_API_KEY=""\n\
    GOOGLE_API_KEY=""\n\
    OPENAI_API_KEY=""\n\
    ANTHROPIC_API_KEY=""\n\
    MONGODB_ENABLED="false"\n\
    REDIS_ENABLED="false"\n\
    MONGODB_HOST="localhost"\n\
    MONGODB_PORT="27017"\n\
    REDIS_HOST="localhost"\n\
    REDIS_PORT="6379"\n\
    LOG_LEVEL="info"\n\
fi\n\
\n\
# åˆ›å»º.envæ–‡ä»¶\n\
ENV_FILE="/opt/tradingagents/.env"\n\
echo "Creating environment file at $ENV_FILE"\n\
cat > "$ENV_FILE" <<EOF\n\
DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}\n\
TUSHARE_TOKEN=${TUSHARE_TOKEN}\n\
FINNHUB_API_KEY=${FINNHUB_API_KEY}\n\
GOOGLE_API_KEY=${GOOGLE_API_KEY}\n\
OPENAI_API_KEY=${OPENAI_API_KEY}\n\
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}\n\
MONGODB_ENABLED=${MONGODB_ENABLED}\n\
REDIS_ENABLED=${REDIS_ENABLED}\n\
MONGODB_HOST=${MONGODB_HOST}\n\
MONGODB_PORT=${MONGODB_PORT}\n\
REDIS_HOST=${REDIS_HOST}\n\
REDIS_PORT=${REDIS_PORT}\n\
TRADING_AGENTS_DATA_DIR=/data/tradingagents\n\
LOG_LEVEL=${LOG_LEVEL}\n\
MONGODB_DATABASE=trading_agents\n\
MONGODB_USERNAME=\n\
MONGODB_PASSWORD=\n\
REDIS_PASSWORD=\n\
REDIS_DB=0\n\
DOCKER_CONTAINER=true\n\
EOF\n\
\n\
# æ˜¾ç¤ºé…ç½®ä¿¡æ¯\n\
echo "=== TradingAgents-CN Configuration ===="n\
echo "ğŸ¤– AI Models:"\n\
[[ -n "$DASHSCOPE_API_KEY" ]] && echo "  âœ… é˜¿é‡Œç™¾ç‚¼ (Dashscope) - å·²é…ç½®" || echo "  âŒ é˜¿é‡Œç™¾ç‚¼ (Dashscope) - æœªé…ç½® [å¿…éœ€]"\n\
[[ -n "$GOOGLE_API_KEY" ]] && echo "  âœ… Google AI - å·²é…ç½®" || echo "  âšª Google AI - æœªé…ç½® [å¯é€‰]"\n\
[[ -n "$OPENAI_API_KEY" ]] && echo "  âœ… OpenAI - å·²é…ç½®" || echo "  âšª OpenAI - æœªé…ç½® [å¯é€‰]"\n\
[[ -n "$ANTHROPIC_API_KEY" ]] && echo "  âœ… Anthropic - å·²é…ç½®" || echo "  âšª Anthropic - æœªé…ç½® [å¯é€‰]"\n\
echo ""\n\
echo "ğŸ“Š Data Sources:"\n\
[[ -n "$TUSHARE_TOKEN" ]] && echo "  âœ… Tushare - å·²é…ç½® (æ”¯æŒAè‚¡ã€æ¸¯è‚¡ç­‰ä¸­å›½å¸‚åœº)" || echo "  âšª Tushare - æœªé…ç½® (Aè‚¡æ•°æ®æº)"\n\
[[ -n "$FINNHUB_API_KEY" ]] && echo "  âœ… FinnHub - å·²é…ç½® (æ”¯æŒç¾è‚¡ç­‰å…¨çƒå¸‚åœº)" || echo "  âšª FinnHub - æœªé…ç½® (ç¾è‚¡æ•°æ®æº)"\n\
echo ""\n\
# æ£€æŸ¥æ•°æ®æºé…ç½®çŠ¶æ€\n\
if [[ -n "$TUSHARE_TOKEN" && -n "$FINNHUB_API_KEY" ]]; then\n\
    echo "ğŸŒ æ”¯æŒå…¨çƒè‚¡ç¥¨åˆ†æ (Aè‚¡ + ç¾è‚¡)"\n\
elif [[ -n "$TUSHARE_TOKEN" ]]; then\n\
    echo "ğŸ‡¨ğŸ‡³ æ”¯æŒä¸­å›½å¸‚åœºåˆ†æ (Aè‚¡ã€æ¸¯è‚¡ç­‰)"\n\
elif [[ -n "$FINNHUB_API_KEY" ]]; then\n\
    echo "ğŸ‡ºğŸ‡¸ æ”¯æŒç¾è‚¡ç­‰å…¨çƒå¸‚åœºåˆ†æ"\n\
else\n\
    echo "âš ï¸  è­¦å‘Š: æœªé…ç½®ä»»ä½•æ•°æ®æºAPIï¼Œè‚¡ç¥¨æ•°æ®è·å–å¯èƒ½å—é™"\n\
    echo "ğŸ’¡ å»ºè®®: é…ç½® tushare_token (Aè‚¡) æˆ– finnhub_api_key (ç¾è‚¡)"\n\
fi\n\
echo ""\n\
echo "âš™ï¸  Other Settings:"\n\
echo "  - LOG_LEVEL: $LOG_LEVEL"\n\
echo "  - MONGODB_ENABLED: $MONGODB_ENABLED"\n\
echo "  - REDIS_ENABLED: $REDIS_ENABLED"\n\
echo "======================================"\n\
\n\
# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨\n\
mkdir -p /data/tradingagents\n\
echo "Data directory ready: /data/tradingagents"\n\
\n\
# å¯åŠ¨åº”ç”¨\n\
cd /opt/tradingagents\n\
echo "Starting Streamlit application on port 8501..."\n\
exec python -m streamlit run web/app.py \\\n\
    --server.address 0.0.0.0 \\\n\
    --server.port 8501 \\\n\
    --server.headless true \\\n\
    --server.enableCORS false \\\n\
    --server.enableXsrfProtection false \\\n\
    --server.fileWatcherType none\n\
' > /usr/local/bin/start.sh && chmod +x /usr/local/bin/start.sh

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /data/tradingagents && \
    mkdir -p /config/tradingagents

# æš´éœ²ç«¯å£
EXPOSE 8501

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# è®¾ç½®æ ‡ç­¾
LABEL \
    io.hass.name="TradingAgents-CN" \
    io.hass.description="åŸºäºå¤šæ™ºèƒ½ä½“LLMçš„ä¸­æ–‡é‡‘èäº¤æ˜“æ¡†æ¶" \
    io.hass.arch="${TARGETARCH}" \
    io.hass.type="addon" \
    io.hass.version="1.0.1" \
    maintainer="wuwweizn"

# ç›´æ¥å¯åŠ¨åº”ç”¨
CMD ["/usr/local/bin/start.sh"]