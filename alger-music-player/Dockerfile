# ç¬¬ä¸€é˜¶æ®µï¼šæå–åŸå§‹åº”ç”¨
FROM banksiae/alger-music-player:latest as source-app

# ç¬¬äºŒé˜¶æ®µï¼šæ„å»º UnblockNeteaseMusic
FROM node:18-alpine as unm-builder
WORKDIR /opt
RUN apk add --no-cache git
RUN git clone --depth=1 https://github.com/UnblockNeteaseMusic/server.git unm
WORKDIR /opt/unm
RUN npm install --production --no-audit && \
    npm cache clean --force && \
    # éªŒè¯å¿…è¦æ–‡ä»¶
    test -f app.js && \
    echo "UnblockNeteaseMusic build complete"

# ç¬¬ä¸‰é˜¶æ®µï¼šæ„å»ºæœ€ç»ˆé•œåƒ
ARG BUILD_FROM
FROM $BUILD_FROM

# è®¾ç½®æ ‡ç­¾
LABEL \
    io.hass.name="Alger Music Player" \
    io.hass.description="ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒé«˜éŸ³è´¨æ’­æ”¾å’Œå†…ç½®UnblockNeteaseMusicæœåŠ¡" \
    io.hass.arch="${BUILD_ARCH}" \
    io.hass.type="addon" \
    io.hass.version="${BUILD_VERSION}" \
    maintainer="wuwweizn" \
    org.opencontainers.image.title="Alger Music Player Add-on" \
    org.opencontainers.image.description="ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ Home Assistant åŠ è½½é¡¹" \
    org.opencontainers.image.source="https://github.com/wuwweizn/wwzn-china"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    NODE_ENV=production \
    UNM_PORT=3001 \
    ALGER_PORT=3000 \
    UNM_SOURCE="netease qq kuwo kugou baidu migu"

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    bash \
    nodejs \
    npm \
    nginx \
    curl \
    ca-certificates \
    supervisor \
    tzdata \
    net-tools \
    && update-ca-certificates

# åˆ›å»ºç”¨æˆ·å’Œç›®å½•
RUN addgroup -g 1001 app && \
    adduser -D -s /bin/bash -u 1001 -G app app && \
    mkdir -p /app /opt/unm /var/log/nginx /run/nginx /etc/supervisor.d && \
    chown -R nginx:nginx /var/log/nginx /run/nginx

# ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶åŸå§‹åº”ç”¨ - æ›´è¯¦ç»†çš„å¤åˆ¶
COPY --from=source-app /app /tmp/source-app
RUN cp -r /tmp/source-app/* /app/ 2>/dev/null || cp -r /tmp/source-app/. /app/ 2>/dev/null || true && \
    chown -R app:app /app && \
    # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    ls -la /app/ && \
    echo "App directory contents:" && \
    find /app -type f -name "*.js" -o -name "*.json" | head -10

# ä»ç¬¬äºŒé˜¶æ®µå¤åˆ¶ UnblockNeteaseMusic
COPY --from=unm-builder /opt/unm /opt/unm
RUN chown -R app:app /opt/unm && \
    # éªŒè¯ UNM æ–‡ä»¶
    test -f /opt/unm/app.js && \
    echo "UnblockNeteaseMusic files verified"

# åˆ›å»ºæ”¹è¿›çš„å¯åŠ¨è„šæœ¬
RUN cat > /usr/local/bin/docker-entrypoint.sh << 'EOF'
#!/bin/bash
set -e

# è®¾ç½®é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"; }
log_success() { echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] âœ…${NC} $1"; }
log_warning() { echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] âš ï¸${NC} $1"; }
log_error() { echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] âŒ${NC} $1"; }

cat << 'BANNER'
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘        ğŸµ Alger Music Player Add-on        â•‘
    â•‘                                           â•‘
    â•‘     With UnblockNeteaseMusic Support      â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER

log "Initializing Alger Music Player Home Assistant Add-on..."

# è¯»å–é…ç½®
if command -v bashio &> /dev/null; then
    MUSIC_API_URL=$(bashio::config 'music_api_url' 'http://localhost:3001')
    LOG_LEVEL=$(bashio::config 'log_level' 'info')
    ENABLE_UNM=$(bashio::config 'enable_unm' 'true')
    UNM_SOURCE=$(bashio::config 'unm_source' 'netease qq kuwo kugou baidu migu')
else
    MUSIC_API_URL=${MUSIC_API_URL:-"http://localhost:3001"}
    LOG_LEVEL=${LOG_LEVEL:-"info"}
    ENABLE_UNM=${ENABLE_UNM:-"true"}
    UNM_SOURCE=${UNM_SOURCE:-"netease qq kuwo kugou baidu migu"}
fi

export MUSIC_API_URL LOG_LEVEL ENABLE_UNM UNM_SOURCE

# éªŒè¯æ–‡ä»¶
log "Verifying installation..."

# æ£€æŸ¥ app ç›®å½•
log "App directory contents:"
ls -la /app/ || log_error "App directory is empty or doesn't exist"

# æ£€æŸ¥å…³é”®æ–‡ä»¶
if [ ! -f "/app/server.js" ] && [ ! -f "/app/app.js" ] && [ ! -f "/app/index.js" ]; then
    log_warning "No main server file found, checking for alternatives..."
    
    # å¯»æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
    MAIN_FILE=$(find /app -name "*.js" -type f | grep -E "(server|app|index|main)" | head -1)
    if [ -n "$MAIN_FILE" ]; then
        log "Found potential main file: $MAIN_FILE"
        # åˆ›å»ºç¬¦å·é“¾æ¥
        ln -sf "$MAIN_FILE" /app/server.js
    else
        log_warning "Creating fallback server.js..."
        cat > /app/server.js << 'FALLBACK_EOF'
const express = require('express');
const path = require('path');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();
const PORT = process.env.PORT || 3000;

// é™æ€æ–‡ä»¶æœåŠ¡
const staticPath = path.join(__dirname, 'dist') || path.join(__dirname, 'public') || path.join(__dirname, 'build');
if (require('fs').existsSync(staticPath)) {
    app.use(express.static(staticPath));
    console.log(`Serving static files from: ${staticPath}`);
} else {
    console.log('No static files directory found, serving basic HTML');
    app.get('/', (req, res) => {
        res.send(`
<!DOCTYPE html>
<html><head><title>Alger Music Player</title>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>body{font-family:Arial,sans-serif;margin:0;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;min-height:100vh;display:flex;align-items:center;justify-content:center;text-align:center}.container{background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.3)}h1{margin-bottom:20px}.status{padding:10px 20px;border-radius:10px;background:rgba(255,255,255,0.2);margin:20px 0}</style>
</head><body>
<div class="container">
<h1>ğŸµ Alger Music Player</h1>
<div class="status">éŸ³ä¹æœåŠ¡æ­£åœ¨è¿è¡Œ</div>
<p>UnblockNeteaseMusic å·²å¯ç”¨</p>
<p><a href="/unm/" style="color:#fff">è®¿é—® UNM æœåŠ¡</a></p>
</div>
</body></html>
        `);
    });
}

// API è·¯ç”±
app.get('/api/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        message: 'Alger Music Player is running',
        timestamp: new Date().toISOString(),
        unm_url: 'http://localhost:3001'
    });
});

// ä»£ç†åˆ° UNM
app.use('/api/music', createProxyMiddleware({
    target: 'http://localhost:3001',
    changeOrigin: true,
    pathRewrite: { '^/api/music': '' }
}));

app.listen(PORT, '0.0.0.0', () => {
    console.log(`ğŸµ Alger Music Player backend running on port ${PORT}`);
});
FALLBACK_EOF

        # å®‰è£…å¿…è¦çš„ä¾èµ–
        cd /app
        cat > package.json << 'PKG_EOF'
{
  "name": "alger-music-player-fallback",
  "version": "1.0.0",
  "description": "Alger Music Player Fallback Server",
  "main": "server.js",
  "dependencies": {
    "express": "^4.18.0",
    "http-proxy-middleware": "^2.0.0"
  },
  "scripts": {
    "start": "node server.js"
  }
}
PKG_EOF
        npm install --production
    fi
fi

# éªŒè¯ UNM
if [ ! -f "/opt/unm/app.js" ]; then
    log_error "UnblockNeteaseMusic not found!"
    exit 1
fi

# æµ‹è¯• UNM æ˜¯å¦å¯ä»¥å¯åŠ¨
log "Testing UnblockNeteaseMusic..."
cd /opt/unm
timeout 10s node app.js --help > /dev/null 2>&1 || log_warning "UNM test failed, but continuing..."

log_success "File verification complete"

# è®¾ç½®æƒé™
chown -R app:app /app /opt/unm
chown -R nginx:nginx /var/log/nginx /run/nginx

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /var/log
touch /var/log/supervisord.log

log_success "Starting services with supervisor..."
exec /usr/bin/supervisord -c /etc/supervisor.d/supervisord.conf
EOF

RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# åˆ›å»ºæ”¹è¿›çš„ supervisor é…ç½®
RUN cat > /etc/supervisor.d/supervisord.conf << 'EOF'
[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=/var/run/supervisord.pid
childlogdir=/var/log
user=root

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# UnblockNeteaseMusic æœåŠ¡
[program:unm]
command=node app.js -p 3001 -o -s %(ENV_UNM_SOURCE)s
directory=/opt/unm
user=app
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/unm_error.log
stderr_logfile_maxbytes=10MB
stdout_logfile=/var/log/unm_output.log
stdout_logfile_maxbytes=10MB
environment=PORT=3001,HOST=0.0.0.0,NODE_ENV=production,UNM_SOURCE="%(ENV_UNM_SOURCE)s"
priority=100

# Alger Music Player åç«¯
[program:alger-backend]
command=node server.js
directory=/app
user=app
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/alger_backend_error.log
stderr_logfile_maxbytes=10MB
stdout_logfile=/var/log/alger_backend_output.log
stdout_logfile_maxbytes=10MB
environment=PORT=3000,NODE_ENV=production,MUSIC_API_URL="%(ENV_MUSIC_API_URL)s"
priority=200
depends_on=unm

# Nginx Web æœåŠ¡å™¨
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
startsecs=3
startretries=3
stderr_logfile=/var/log/nginx_error.log
stderr_logfile_maxbytes=10MB
stdout_logfile=/var/log/nginx_output.log
stdout_logfile_maxbytes=10MB
priority=300
EOF

# åˆ›å»º nginx é…ç½®
RUN cat > /etc/nginx/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;
    
    server {
        listen 3010 default_server;
        server_name _;
        root /app/dist;
        index index.html index.htm;
        
        # å°è¯•å¤šä¸ªé™æ€æ–‡ä»¶ä½ç½®
        location / {
            try_files $uri $uri/ @fallback;
        }
        
        # å›é€€åˆ°å…¶ä»–å¯èƒ½çš„é™æ€æ–‡ä»¶ç›®å½•
        location @fallback {
            root /app/public;
            try_files $uri $uri/ @backend;
        }
        
        # æœ€ç»ˆå›é€€åˆ°åç«¯
        location @backend {
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # åç«¯ API ä»£ç†
        location /api/ {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # éŸ³ä¹ API ä»£ç†
        location /api_music/ {
            rewrite ^/api_music/(.*) /$1 break;
            proxy_pass http://127.0.0.1:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # CORS æ”¯æŒ
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
                add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type 'text/plain; charset=utf-8';
                add_header Content-Length 0;
                return 204;
            }
        }
        
        # UnblockNeteaseMusic ç›´æ¥è®¿é—®
        location /unm/ {
            rewrite ^/unm/(.*) /$1 break;
            proxy_pass http://127.0.0.1:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
EOF

# åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
RUN mkdir -p /usr/share/nginx/html && \
    echo '<h1>Service Unavailable</h1>' > /usr/share/nginx/html/50x.html && \
    echo '<h1>Not Found</h1>' > /usr/share/nginx/html/404.html

# éªŒè¯å®‰è£…
RUN test -f /opt/unm/app.js && echo "âœ… UnblockNeteaseMusic verified" && \
    ls -la /app/ && echo "âœ… App directory verified"

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3010/health || curl -f http://localhost:3010/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3010

# å¯åŠ¨å‘½ä»¤
CMD ["/usr/local/bin/docker-entrypoint.sh"]